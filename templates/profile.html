{% extends "base.html" %}

{% block title %}My Profile - Disease Matcher{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-user"></i> My Profile</h5>
                    <a href="{{ url_for('patients.download_report', patient_id=user.id) }}"
                        class="btn btn-sm btn-light">
                        <i class="fas fa-file-pdf"></i> Download Report
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Personal Information</h6>
                            <p><strong>Name:</strong> {{ user.name }}</p>
                            <p><strong>Age:</strong> {{ user.age }}</p>
                            <p><strong>Address:</strong> {{ user.address or 'Not provided' }}</p>
                            <p><strong>Patient ID:</strong> {{ user.id }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Medical Summary</h6>
                            <p><strong>Diseases:</strong> {{ user.diseases|length if user.diseases else 0 }}</p>
                            <p><strong>Visits:</strong> {{ user.visits|length if user.visits else 0 }}</p>
                            <p><strong>Appointments:</strong> {{ user.appointments|length if user.appointments else 0 }}
                            </p>
                            <p><strong>Prescriptions:</strong> {{ user.prescriptions|length if user.prescriptions else 0
                                }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Risk Analysis Section -->
        {% if risks %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> AI Risk Assessment</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    These are AI-generated predictions based on your history. Please consult a doctor for verification.
                </div>
                <div class="row">
                    {% for risk in risks %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 border-{{ 'danger' if risk.risk_level == 'High' else 'warning' }}">
                            <div class="card-body">
                                <h6 class="card-title text-{{ 'danger' if risk.risk_level == 'High' else 'warning' }}">
                                    {{ risk.condition }}
                                </h6>
                                <p class="card-text">{{ risk.message }}</p>
                                <div class="progress">
                                    <div class="progress-bar bg-{{ 'danger' if risk.risk_level == 'High' else 'warning' }}"
                                        role="progressbar" style="width: {{ risk.probability }}%;"
                                        aria-valuenow="{{ risk.probability }}" aria-valuemin="0" aria-valuemax="100">{{
                                        risk.probability }}%</div>
                                </div>
                                <small class="text-muted mt-2 d-block">Probability: {{ risk.probability }}%</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}


        <!-- Update Profile Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-edit"></i> Update Profile</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('auth.profile') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="update_profile">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">Name:</label>
                                <input type="text" class="form-control" id="name" name="name" value="{{ user.name }}"
                                    required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="age" class="form-label">Age:</label>
                                <input type="number" class="form-control" id="age" name="age" value="{{ user.age }}"
                                    min="1" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address:</label>
                        <textarea class="form-control" id="address" name="address"
                            rows="3">{{ user.address or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">New Password (leave blank to keep current):</label>
                        <input type="password" class="form-control" id="password" name="password">
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Profile</button>
                </form>
            </div>
        </div>

        <!-- Book Appointment Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-plus"></i> Book New Appointment</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{{ url_for('auth.profile') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <input type="hidden" name="action" value="book_appointment">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appt_date" class="form-label">Preferred Date:</label>
                                <input type="date" class="form-control" id="appt_date" name="appt_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="appt_time" class="form-label">Preferred Time:</label>
                                <input type="time" class="form-control" id="appt_time" name="appt_time" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="purpose" class="form-label">Purpose of Visit:</label>
                        <select class="form-control" id="purpose" name="purpose" required>
                            <option value="">Select purpose</option>
                            <option value="General Checkup">General Checkup</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Consultation">Consultation</option>
                            <option value="Emergency">Emergency</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Additional Notes:</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"
                            placeholder="Any specific symptoms or concerns..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success"><i class="fas fa-calendar-check"></i> Book
                        Appointment</button>
                </form>
            </div>
        </div>

        <!-- Medical History Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Medical History</h5>
            </div>
            <div class="card-body">
                {% if user.diseases %}
                <h6>Diseases</h6>
                <ul class="list-group mb-3">
                    {% for disease in user.diseases %}
                    <li class="list-group-item">
                        <strong>{{ disease.name }}</strong> - Added: {{ disease.added_date[:10] if disease.added_date
                        else 'N/A' }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No diseases recorded.</p>
                {% endif %}

                {% if user.visits %}
                <h6>Visit History</h6>
                <ul class="list-group mb-3">
                    {% for visit in user.visits %}
                    <li class="list-group-item">
                        <strong>{{ visit.date }} at {{ visit.time }}</strong>
                        {% if visit.notes %}<br><small>{{ visit.notes }}</small>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No visits recorded.</p>
                {% endif %}

                {% if user.appointments %}
                <h6>Upcoming Appointments</h6>
                <ul class="list-group mb-3">
                    {% for appt in user.appointments %}
                    <li class="list-group-item">
                        <strong>{{ appt.date }} at {{ appt.time }}</strong> - {{ appt.purpose }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No upcoming appointments.</p>
                {% endif %}

                {% if user.prescriptions %}
                <h6>Current Prescriptions</h6>
                <ul class="list-group mb-3">
                    {% for presc in user.prescriptions %}
                    <li class="list-group-item">
                        <strong>{{ presc.medication }}</strong> - {{ presc.dosage }} for {{ presc.duration }}
                        {% if presc.notes %}<br><small>{{ presc.notes }}</small>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No prescriptions.</p>
                {% endif %}

                {% if user.lab_tests %}
                <h6>Lab Tests</h6>
                <ul class="list-group mb-3">
                    {% for test in user.lab_tests %}
                    <li class="list-group-item">
                        <strong>{{ test.name }}</strong> - Ordered: {{ test.date }}
                        {% if test.notes %}<br><small>{{ test.notes }}</small>{% endif %}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p>No lab tests recorded.</p>
                {% endif %}
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-tools"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <a href="{{ url_for('main.match') }}" class="btn btn-outline-primary w-100 mb-2">
                            <i class="fas fa-search"></i> Symptom Checker
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('main.find') }}" class="btn btn-outline-secondary w-100 mb-2">
                            <i class="fas fa-book"></i> Disease Lookup
                        </a>
                    </div>
                    <div class="col-md-4">
                        <a href="{{ url_for('main.chat') }}" class="btn btn-outline-success w-100 mb-2">
                            <i class="fas fa-robot"></i> AI Assistant
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}