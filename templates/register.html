{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h2 class="text-center mb-0">Patient Registration</h2>
                </div>
                <div class="card-body">
                    <form method="POST" id="registerForm" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

                        <!-- Account Details -->
                        <h4 class="mb-3 text-muted">Account</h4>
                        <div class="form-group mb-3">
                            <label for="username">Username</label>
                            <input type="text" class="form-control" id="username" name="username" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="password">Password</label>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="confirm_password">Confirm Password</label>
                                    <input type="password" class="form-control" id="confirm_password"
                                        name="confirm_password" required>
                                </div>
                            </div>
                        </div>

                        <hr>

                        <!-- Personal Details -->
                        <h4 class="mb-3 text-muted">Personal Information</h4>
                        <div class="row">
                            <div class="col-md-8">
                                <div class="form-group mb-3">
                                    <label for="name">Full Name</label>
                                    <input type="text" class="form-control" id="name" name="name" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group mb-3">
                                    <label for="age">Age</label>
                                    <input type="number" class="form-control" id="age" name="age" required>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="address">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                        </div>

                        <div class="form-group mb-4">
                            <label for="image" class="form-weight-bold">Face Photo (Required for AI)</label>

                            <!-- Camera Toggle & Status -->
                            <div class="d-flex gap-2 mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="startCameraBtn">
                                    <i class="fas fa-camera"></i> Use Camera
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm d-none" id="stopCameraBtn">
                                    <i class="fas fa-stop"></i> Stop Camera
                                </button>
                            </div>

                            <!-- Camera Feed Container -->
                            <div id="camera-container" class="d-none mb-3 text-center bg-light p-2 rounded">
                                <video id="video" width="320" height="240" autoplay
                                    class="border rounded d-block mx-auto mb-2"></video>
                                <button type="button" class="btn btn-success btn-sm" id="captureBtn">
                                    <i class="fas fa-check-circle"></i> Capture Photo
                                </button>
                                <canvas id="canvas" width="320" height="240" class="d-none"></canvas>
                            </div>

                            <!-- File Input -->
                            <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                            <small class="form-text text-muted" id="photo-help">Upload a clear photo or use the
                                camera.</small>
                        </div>

                        <script>
                            const video = document.getElementById('video');
                            const canvas = document.getElementById('canvas');
                            const startBtn = document.getElementById('startCameraBtn');
                            const stopBtn = document.getElementById('stopCameraBtn');
                            const captureBtn = document.getElementById('captureBtn');
                            const fileInput = document.getElementById('image');
                            const cameraContainer = document.getElementById('camera-container');
                            let stream = null;

                            startBtn.addEventListener('click', async () => {
                                try {
                                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                                    video.srcObject = stream;
                                    cameraContainer.classList.remove('d-none');
                                    startBtn.classList.add('d-none');
                                    stopBtn.classList.remove('d-none');
                                } catch (err) {
                                    alert("Could not access camera: " + err);
                                }
                            });

                            stopBtn.addEventListener('click', () => {
                                if (stream) {
                                    stream.getTracks().forEach(track => track.stop());
                                    stream = null;
                                    video.srcObject = null;
                                }
                                cameraContainer.classList.add('d-none');
                                startBtn.classList.remove('d-none');
                                stopBtn.classList.add('d-none');
                            });

                            captureBtn.addEventListener('click', () => {
                                const context = canvas.getContext('2d');
                                context.drawImage(video, 0, 0, 320, 240);

                                canvas.toBlob((blob) => {
                                    const file = new File([blob], "webcam_capture.jpg", { type: "image/jpeg" });
                                    const dataTransfer = new DataTransfer();
                                    dataTransfer.items.add(file);
                                    fileInput.files = dataTransfer.files;

                                    // Stop camera after capture
                                    stopBtn.click();
                                    alert("Photo captured successfully!");
                                }, 'image/jpeg');
                            });
                        </script>

                        <button type="submit" class="btn btn-primary btn-block w-100">Register</button>
                    </form>

                    <div class="mt-3 text-center">
                        <a href="{{ url_for('auth.login') }}">Already have an account? Login here</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}