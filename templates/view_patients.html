{% extends "base.html" %}

{% block title %}View All Patients - Disease Matcher{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endfor %}
{% endif %}
{% endwith %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center flex-wrap">
                <h5 class="mb-0"><i class="fas fa-users"></i> All Patients</h5>
                <div class="d-flex align-items-center flex-wrap">
                    <div class="input-group me-2" style="max-width: 300px;">
                        <input type="text" id="searchInput" class="form-control" placeholder="Search by name or ID...">
                        <button class="btn btn-outline-light" type="button" id="clearSearch"><i
                                class="fas fa-times"></i></button>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('patients.export_patients_csv') }}" class="btn btn-outline-light btn-sm"><i
                                class="fas fa-download"></i> Export CSV</a>
                        <button class="btn btn-outline-light btn-sm" id="selectAllBtn"><i
                                class="fas fa-check-square"></i> Select All</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if patients %}
                <form id="bulkForm" method="post" action="{{ url_for('patients.bulk_delete_patients') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="patientsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th scope="col"><input type="checkbox" id="selectAll"></th>
                                    <th scope="col" data-sort="id" class="d-none d-md-table-cell">ID <i
                                            class="fas fa-sort"></i></th>
                                    <th scope="col" data-sort="name">Name <i class="fas fa-sort"></i></th>
                                    <th scope="col" data-sort="age" class="d-none d-lg-table-cell">Age <i
                                            class="fas fa-sort"></i></th>
                                    <th scope="col" data-sort="address" class="d-none d-xl-table-cell">Address <i
                                            class="fas fa-sort"></i></th>
                                    <th scope="col" data-sort="diseases" class="d-none d-lg-table-cell">Diseases <i
                                            class="fas fa-sort"></i></th>
                                    <th scope="col" class="d-none d-md-table-cell">Image</th>
                                    <th scope="col">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for patient in patients %}
                                <tr>
                                    <td><input type="checkbox" name="selected_patients" value="{{ patient.id }}"></td>
                                    <td class="d-none d-md-table-cell">{{ patient.id }}</td>
                                    <td>{{ patient.name }}</td>
                                    <td class="d-none d-lg-table-cell">{{ patient.age }}</td>
                                    <td class="d-none d-xl-table-cell">{{ patient.address or 'N/A' }}</td>
                                    <td class="d-none d-lg-table-cell">
                                        {% if patient.diseases %}
                                        {% for disease in patient.diseases %}
                                        {% if disease.name %}
                                        {{ disease.name }}
                                        {% else %}
                                        {{ disease }}
                                        {% endif %}
                                        {% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                        {% else %}
                                        None
                                        {% endif %}
                                    </td>
                                    <td class="d-none d-md-table-cell">
                                        {% if patient.image_path %}
                                        <img src="{{ url_for('static', filename='uploads/' ~ patient.image_path.replace('\\', '/').split('/')[-1]) }}"
                                            alt="Patient Photo" class="img-thumbnail"
                                            style="width: 50px; height: 50px; object-fit: cover;">
                                        {% else %}
                                        <span class="text-muted">No image</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('patients.update_patient', patient_id=patient.id) }}"
                                            class="btn btn-warning btn-sm"><i class="fas fa-edit"></i> Update</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 d-flex justify-content-between align-items-center flex-wrap">
                        <div class="btn-group" role="group">
                            <button type="submit" class="btn btn-danger btn-sm" id="bulkDeleteBtn" disabled><i
                                    class="fas fa-trash"></i> Delete Selected</button>
                        </div>
                        <small class="text-muted">Selected: <span id="selectedCount">0</span></small>
                    </div>
                </form>
                {% else %}
                <p class="text-center text-muted">No patients found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="text-center mt-3">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Back to Home</a>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const table = document.getElementById('patientsTable');
        const tbody = table.querySelector('tbody');
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const headers = table.querySelectorAll('th[data-sort]');
        const selectAllCheckbox = document.getElementById('selectAll');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectedCount = document.getElementById('selectedCount');
        const checkboxes = tbody.querySelectorAll('input[name="selected_patients"]');

        let sortDirection = {};

        // Sorting function
        function sortTable(column) {
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isNumeric = column === 'age';
            const direction = sortDirection[column] = !sortDirection[column];

            rows.sort((a, b) => {
                const aVal = a.cells[column === 'id' ? 1 : column === 'name' ? 2 : column === 'age' ? 3 : column === 'address' ? 4 : 5].textContent.trim().toLowerCase();
                const bVal = b.cells[column === 'id' ? 1 : column === 'name' ? 2 : column === 'age' ? 3 : column === 'address' ? 4 : 5].textContent.trim().toLowerCase();

                if (isNumeric) {
                    return direction ? parseInt(aVal) - parseInt(bVal) : parseInt(bVal) - parseInt(aVal);
                } else {
                    return direction ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });

            rows.forEach(row => tbody.appendChild(row));

            // Update sort icons
            headers.forEach(th => {
                const icon = th.querySelector('i');
                if (th.dataset.sort === column) {
                    icon.className = direction ? 'fas fa-sort-up' : 'fas fa-sort-down';
                } else {
                    icon.className = 'fas fa-sort';
                }
            });
        }

        // Attach sort event listeners
        headers.forEach(th => {
            th.addEventListener('click', () => sortTable(th.dataset.sort));
        });

        // Filtering function
        function filterTable() {
            const query = searchInput.value.toLowerCase();
            const rows = tbody.querySelectorAll('tr');

            rows.forEach(row => {
                const name = row.cells[2].textContent.toLowerCase();
                const id = row.cells[1].textContent.toLowerCase();
                const visible = name.includes(query) || id.includes(query);
                row.style.display = visible ? '' : 'none';
            });
            updateBulkActions();
        }

        // Search input event
        searchInput.addEventListener('input', filterTable);

        // Clear search
        clearSearch.addEventListener('click', () => {
            searchInput.value = '';
            filterTable();
        });

        // Bulk actions functions
        function updateBulkActions() {
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => cb.closest('tr').style.display !== 'none');
            const checked = visibleCheckboxes.filter(cb => cb.checked);
            selectedCount.textContent = checked.length;
            bulkDeleteBtn.disabled = checked.length === 0;
            selectAllCheckbox.checked = visibleCheckboxes.length > 0 && visibleCheckboxes.every(cb => cb.checked);
            selectAllCheckbox.indeterminate = visibleCheckboxes.some(cb => cb.checked) && !selectAllCheckbox.checked;
        }

        // Select all button
        selectAllBtn.addEventListener('click', () => {
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => cb.closest('tr').style.display !== 'none');
            const allChecked = visibleCheckboxes.every(cb => cb.checked);
            visibleCheckboxes.forEach(cb => cb.checked = !allChecked);
            updateBulkActions();
        });

        // Master select all checkbox
        selectAllCheckbox.addEventListener('change', () => {
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => cb.closest('tr').style.display !== 'none');
            visibleCheckboxes.forEach(cb => cb.checked = selectAllCheckbox.checked);
            updateBulkActions();
        });

        // Individual checkboxes
        checkboxes.forEach(cb => {
            cb.addEventListener('change', updateBulkActions);
        });

        // Initial update
        updateBulkActions();
    });
</script>
{% endblock %}